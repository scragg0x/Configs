user www-data;
worker_processes 8;
pid /var/run/nginx.pid;

events {
        worker_connections 4096;
        # multi_accept on;
}

http {

        ##
        # Basic Settings
        ##

        log_format cache '$remote_addr - $host [$time_local]  '
                 '"$request" $status $upstream_cache_status $body_bytes_sent '
                 '"$http_referer" "$http_user_agent"';


        # Configure cache and temp paths
        fastcgi_cache_path /var/cache/nginx levels=1:2
                keys_zone=tt:100m
                inactive=7d max_size=10g;

        fastcgi_temp_path /var/cache/nginx/tmp;

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        # server_tokens off;

        # server_names_hash_bucket_size 64;
        # server_name_in_redirect off;

        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        charset utf-8;
        ##
        # Logging Settings
        ##

        #access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        access_log off;

        ##
        # Gzip Settings
        ##
        gzip on;
        gzip_disable "msie6";

        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_buffers 16 8k;
        gzip_http_version 1.1;
        gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

        ##
        # nginx-naxsi config
        ##
        # Uncomment it if you installed nginx-naxsi
        ##

        #include /etc/nginx/naxsi_core.rules;

        ##
        # nginx-passenger config
        ##
        # Uncomment it if you installed nginx-passenger
        ##

        #passenger_root /usr;
        #passenger_ruby /usr/bin/ruby;

        ##
        # Virtual Host Configs
        ##

        include /etc/nginx/conf.d/*.conf;
        include /etc/nginx/sites-enabled/*;
}


#mail {
#       # See sample authentication script at:
#       # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
#
#       # auth_http localhost/auth.php;
#       # pop3_capabilities "TOP" "USER";
#       # imap_capabilities "IMAP4rev1" "UIDPLUS";
#
#       server {
#               listen     localhost:110;
#               protocol   pop3;
#               proxy      on;
#       }
#
#       server {
#               listen     localhost:143;
#               protocol   imap;
#               proxy      on;
#       }
#}

# Start FFXIAH
server {
        listen 216.144.246.170:80;
        server_name ffxiah.com;
        rewrite ^ http://www.ffxiah.com$request_uri? permanent;
}

server {
        listen 216.144.246.170:80;
        server_name ffxivpro.com;
        rewrite ^ http://www.ffxivpro.com$request_uri? permanent;
}

server {
        listen 216.144.246.170:80;

        access_log /var/log/nginx/ffxiah-access.log;

        root /var/www/ffxipro.com/public;
        index index.php;

        server_name www.ffxiah.com jp.ffxiah.com de.ffxiah.com fr.ffxiah.com;

        rewrite ^(.*)\.v[0-9]+\.(js|css)$ $1.$2 last;
        rewrite ^/ffxiahify\.php$ /scripts/ffxiahify.php?$args last;
        rewrite ^/widget\.php$ /scripts/widget.php?$args last;

        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
                access_log        off;
                log_not_found     off;
                expires           360d;
        }

        location / {
                # This is cool because no php is touched for static content
                try_files $uri $uri/ /index.php?$args;
        }

        location ~ \.php$ {
                try_files $uri /index.php?$args;
                fastcgi_index   index.php;
                #fastcgi_pass   unix:/tmp/php5-fpm.sock;
                fastcgi_pass 127.0.0.1:9003;
                include         /etc/nginx/fastcgi_params;
                fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;
                fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;
                fastcgi_param   SERVER_NAME        $server_name;
        }

        location ~ /\. {
                deny all;
        }
}

server {
        listen 216.144.246.170:443;
        ssl on;
        ssl_certificate /etc/nginx/ssl/ffxiah.com/ffxiah.com.crt;
        ssl_certificate_key /etc/nginx/ssl/ffxiah.com/ffxiah.com.key;

        root /var/www/ffxipro.com/public;
        index index.php;

        server_name www.ffxiah.com lsn-web.ffxiah.com;

        rewrite ^(.*)\.v[0-9]+\.(js|css)$ $1.$2 last;
        rewrite ^/ffxiahify\.php$ /scripts/ffxiahify.php?$args last;
        rewrite ^/widget\.php$ /scripts/widget.php?$args last;

        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
                access_log        off;
                log_not_found     off;
                expires           360d;
        }

        location / {
                # This is cool because no php is touched for static content
                try_files $uri $uri/ /index.php?$args;
        }

        location ~ \.php$ {
                try_files $uri /index.php?$args;
                fastcgi_index   index.php;
                fastcgi_pass    unix:/tmp/php5-fpm.sock;
                include         fastcgi_params;
                fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;
                fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;
        }

        location ~ /\. {
                deny all;
        }

}

server {
        listen 216.144.246.170:80;
        server_name static.ffxiah.com;
        root /var/www/static.ffxiah.com;
        rewrite ^(.*)\.v[0-9]+\.(js|css)$ $1.$2 last;

        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
                access_log        off;
                log_not_found     off;
                expires           360d;
        }

        location ~ /\. {
                deny all;
        }
}

server {
        listen 216.144.246.170:80;
        server_name api.ffxiah.com api.ffxivpro.com;
        root /var/www/api.ffxivpro.com/public;

        access_log /var/log/nginx/api-access.log;

        index index.php;

        location ~ /tt/(.+)\.php$ {
                try_files $uri /index.php?$args;
                fastcgi_index   index.php;
                fastcgi_pass    127.0.0.1:9003;
                include         fastcgi_params;
                fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;
                fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;

                #Caching parameters
                fastcgi_cache tt;

                fastcgi_cache_key "$scheme$request_method$host$request_uri";

                fastcgi_cache_valid  200 302 304 30m;
                fastcgi_cache_valid  301 1h;
                fastcgi_cache_valid  any 5m;
                fastcgi_cache_use_stale error timeout invalid_header updating http_500;
                access_log /var/log/nginx/api-access.log cache;
        }

        location ~ \.php$ {
                try_files $uri /index.php?$args;
                fastcgi_index   index.php;
                fastcgi_pass    127.0.0.1:9003;
                include         fastcgi_params;
                fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;
                fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;
        }

        location ~ /\. {
                deny all;
        }

}

server {
        listen 216.144.246.170:80;

        root /var/www/ffxivpro.com/public;
        index index.php;

        server_name www.ffxivpro.com jp.ffxivpro.com de.ffxivpro.com fr.ffxivpro.com lsn-web.ffxivpro.com;

        rewrite ^(.*)\.v[0-9]+\.(js|css)$ $1.$2 last;

        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
                access_log        off;
                log_not_found     off;
                expires           360d;
        }

        location / {
                # This is cool because no php is touched for static content
                try_files $uri $uri/ /index.php?$args;
        }

        location ~ \.php$ {
                try_files       $uri /index.php?$args;
                fastcgi_index   index.php;
                fastcgi_pass    unix:/tmp/php5-fpm.sock;
                include         fastcgi_params;
                fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;
                fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;
        }

        location ~ /\. {
                deny all;
        }
}

server {
        listen 216.144.246.170:443;
        ssl on;
        ssl_certificate /etc/nginx/ssl/ffxivpro.com/server.crt;
        ssl_certificate_key /etc/nginx/ssl/ffxivpro.com/server.key;

        root /var/www/ffxivpro.com/public;
        index index.php;

        server_name www.ffxivpro.com lsn-web.ffxivpro.com;

        rewrite ^(.*)\.v[0-9]+\.(js|css)$ $1.$2 last;

        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
                access_log        off;
                log_not_found     off;
                expires           360d;
        }

        location / {
                # This is cool because no php is touched for static content
                try_files $uri $uri/ /index.php?$args;
        }

        location ~ \.php$ {
                try_files $uri /index.php?$args;
                fastcgi_index   index.php;
                fastcgi_pass    unix:/tmp/php5-fpm.sock;
                include         fastcgi_params;
                fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;
                fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;
        }

        location ~ /\. {
                deny all;
        }

}
